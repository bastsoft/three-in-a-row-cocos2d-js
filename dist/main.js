!function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";i.r(t);let n={layout:{board:{width:760,height:690},aside:{width:300}},ballsColor:["yellow","red","blue","purple","green","orange"],colorBoardTitle:{darkGray:cc.color(136,136,136),whiteGray:cc.color(177,177,177)},tileSize:62};n.layout.aside.height=n.layout.board.height,n.layout.width=n.layout.board.width+n.layout.aside.width,n.layout.height=n.layout.board.height,n.getColorBoardTile=function(){return this.lastTileBoard="darkGray"!==this.lastTileBoard?"darkGray":"whiteGray",n.colorBoardTitle[this.lastTileBoard]},n.setMidPoint=function(e){this.midPoint=cc.p(e.width/2-this.sizeBoard/2,e.height/2-this.sizeBoard/2)},n.setMove=function(e=1){this.countMoves=this.countMoves-e,this.countMoves<0&&(this.countMoves=0),this.emitChange(),this.checkWinAndLoose()},n.setCollectedGoals=function(e=1){n.goal.count=n.goal.count-e,n.goal.count<0&&(n.goal.count=0),this.emitChange(),this.checkWinAndLoose()},n.getBallSprite=function(e){const t=cc.spriteFrameCache.getSpriteFrame(e);return cc.Sprite.createWithSpriteFrame(t)},n.emitChange=function(){cc.eventManager.dispatchEvent(new cc.EventCustom("emitChangeLevelModel"))},n.checkWinAndLoose=function(){if(0===this.goal.count){const e=new cc.EventCustom("show_popup");e.setUserData(!0),cc.eventManager.dispatchEvent(e)}if(0===this.countMoves){const e=new cc.EventCustom("show_popup");e.setUserData(!1),cc.eventManager.dispatchEvent(e)}},n.init=function(){n.board=[["","","","","","x","x","x","x"],["","","","","","x","x","x","x"],["","","","","","x","x","x","x"],["","","","","","x","x","x","x"],["","","","","","x","x","x","x"],["","","","","","","","",""],["","","","","","","","",""],["","","","","","","","",""],["","","","","","","","",""]],n.countMoves=12,n.goal={count:10,color:"red"},n.boost={used:!1,enable:!1},n.goal.val=n.ballsColor.indexOf(n.goal.color),n.board=n.board.reverse(),n.midTileSize=n.tileSize/2,n.sizeBoard=n.tileSize*n.board.length,this.emitChange()};var s=n;var o=cc.Layer.extend({onEnter:function(){this._super(),this.init(),this._listener1=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"emitChangeLevelModel",callback:()=>{this.updateLabel(s.countMoves)}}),cc.eventManager.addListener(this._listener1,1)},onExit:function(){cc.eventManager.removeListener(this._listener1),this._super()},updateLabel:function(e){this.labelScore&&this.removeChild(this.labelScore,!0),this.setNewLabelScore(e),this.addChild(this.labelScore)},setNewLabelScore:function(e){const t=cc.TEXT_ALIGNMENT_CENTER,i=cc.VERTICAL_TEXT_ALIGNMENT_CENTER,n=cc.size(300,300);this.labelScore=new cc.LabelTTF("Ходы\n"+e,"Arial",60,n,t,i),this.labelScore.setColor(cc.color(255,255,255,0))}});var c=cc.Layer.extend({score:10,labelScore:null,onEnter:function(){this._super(),this._listener=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"emitChangeLevelModel",callback:()=>{this.updateLabel(s.goal.count)}}),cc.eventManager.addListener(this._listener,1),this.init()},onExit:function(){cc.eventManager.removeListener(this._listener),this._super()},updateLabel:function(e){this.labelScore&&(this.removeChild(this.labelScore,!0),this.removeChild(this.spriteBall,!0)),this.setNewLabelScore(e),this.addChild(this.labelScore),this.spriteBall=s.getBallSprite(s.goal.color),this.spriteBall.x=e.toString().length>1?-35:-25,this.spriteBall.y=-35,this.addChild(this.spriteBall)},setNewLabelScore:function(e){const t=cc.TEXT_ALIGNMENT_CENTER,i=cc.VERTICAL_TEXT_ALIGNMENT_CENTER,n=cc.size(300,300);this.labelScore=new cc.LabelTTF("Задание\n ⦁ "+e,"Arial",60,n,t,i),this.labelScore.setColor(cc.color(255,255,255,0))}});var r=cc.Layer.extend({onEnter(){this._super(),cc.MenuItemFont.setFontName("Arial"),cc.MenuItemFont.setFontSize(50),this.item=new cc.MenuItemFont("Бустер",this.onPushBooster,this);const e=new cc.Menu(this.item);e.alignItemsVertically(),e.setPosition(0,0),this.addChild(e),this._listener=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"emitChangeLevelModel",callback:()=>{this.item.enabled=!s.boost.used}}),cc.eventManager.addListener(this._listener,1)},onExit:function(){cc.eventManager.removeListener(this._listener),this._super()},onPushBooster(){s.boost.used=!0,s.boost.enable=!0,this.item.enabled=!s.boost.used}});var a=cc.LayerColor.extend({onEnter:function(){this._super(),this.changeWidthAndHeight(s.layout.aside.width,s.layout.aside.height),this.setColor(s.colorBoardTitle.darkGray),this.setPosition(cc.p(0,0));const e=this.getContentSize(),t=new o;t.setPosition(cc.p(e.width/2,e.height-100)),this.addChild(t);const i=new c;i.setPosition(cc.p(e.width/2,e.height-300)),this.addChild(i);const n=new r;n.setPosition(cc.p(e.width/2,200)),this.addChild(n)}});var h=cc.Layer.extend({onEnter:function(){this._super(),this.width=s.sizeBoard,this.height=s.sizeBoard,s.board.forEach((e,t)=>e.forEach((e,i)=>this._addTile(i*s.tileSize+s.midTileSize,t*s.tileSize+s.midTileSize,e)))},_addTile:function(e,t,i){if("x"!==i){const i=new cc.LayerColor(s.getColorBoardTile());i.ignoreAnchor=!1,i.setContentSize(s.tileSize,s.tileSize),i.setPosition(e,t),this.addChild(i,0)}}});var l=cc.Layer.extend({speedAnimation:.5,onEnter:function(){this._super(),this.visitedTiles={},this.animationQueue=[],this.width=s.sizeBoard,this.height=s.sizeBoard,this.tileArray=s.board.map((e,t)=>e.map((e,i)=>this._addTile(t,i,e))),this.touchListener=cc.EventListener.create({event:cc.EventListener.MOUSE,onMouseDown:this._onMouseDown.bind(this),onMouseUp:this._onMouseUp.bind(this),onMouseMove:this._onMouseMove.bind(this)}),this._listenerOnShowPopup=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"show_popup",callback:()=>{cc.eventManager.removeListener(this.touchListener),this.pauseListener=!0}},this),this._listenerOnShowPopup=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"close_popup",callback:()=>{this.pauseListener&&cc.eventManager.addListener(this.touchListener),this.pauseListener=!1}},this),cc.eventManager.addListener(this.touchListener,this),cc.eventManager.addListener(this._listenerOnShowPopup,this),this._next()},onExit:function(){cc.eventManager.removeListener(this.touchListener),cc.eventManager.removeListener(this._listenerOnShowPopup),this._super()},_next(){this._checkMatch(),this._executeAnimationQueue(()=>this._fallAndNewBalls(this._next.bind(this)))},_executeAnimationQueue(e){const t=this.animationQueue.length;t||e(0),this.animationQueue.forEach((i,n)=>{const s=i.animationAction;n===t-1&&s.push(cc.callFunc(e.bind(this,t))),i.runAction(cc.sequence(...s))}),this.animationQueue=[]},_fallAndNewBalls(e,t=0){this._fallDown(),this._creatingNewBallsInTop(),this._executeAnimationQueue(i=>{i?this._fallAndNewBalls(e,i):t&&e()})},_fallDown(){for(let e=0;e<this.tileArray.length;e++)for(let t=0;t<this.tileArray.length;t++){let i=!1;null===this.tileArray[e][t]&&(i=this._moveFallSprite(i,e,t,1),i=this._moveFallSprite(i,e,t,1,Math.random()>=.5?1:-1))}},_creatingNewBallsInTop(){const e=this.tileArray.length-1,t=cc.MoveBy.create(this.speedAnimation,new cc.Point(0,-s.tileSize));for(let i=0;i<this.tileArray.length-1;i++){const n=this.tileArray[e][i];if(null===n){const s=this._addTile(e+1,i,n);s.animationAction=[t.clone()],this.animationQueue.push(s),this.tileArray[e][i]=s}}},_moveFallSprite(e,t,i,n=0,o=0){const c=t===this.tileArray.length-1,r=!c&&this.tileArray[t+1][i]&&"x"!==this.tileArray[t+1][i],a=!c&&this.tileArray[t+1][i+1]&&"x"!==this.tileArray[t+1][i+1]&&"x"!==this.tileArray[t+1][i],h=!c&&this.tileArray[t+1][i-1]&&"x"!==this.tileArray[t+1][i-1]&&"x"!==this.tileArray[t+1][i];let l=r;if(1===o&&(l=a),-1===o&&(l=h),!e&&l){const c=this.tileArray[t+n][i+o];c.animationAction=[cc.MoveBy.create(this.speedAnimation,new cc.Point(s.tileSize*o*-1,s.tileSize*n*-1))],this.animationQueue.push(c),this.tileArray[t][i]=c,this.tileArray[t+n][i+o]=null,e=!0}return e},_checkMatch(){const e={match:[]},t={match:[]};for(let i=0;i<this.tileArray.length;i++)for(let n=0;n<this.tileArray.length;n++)this._matchProcessing(e,i,n,!0),this._matchProcessing(t,n,i,!1)},_matchProcessing(e,t,i,n){e.match.length&&this._isMatchCurrentSprite(e.match,t,i,n)?e.match.push([t,i]):(this._checkMatch3(e.match),e.match=this.tileArray[t][i]&&"x"!==this.tileArray[t][i]?[[t,i]]:[])},_isMatchCurrentSprite(e,t,i,n){const s=e[0];if(s&&this.tileArray[s[0]][s[1]]){const e=this.tileArray[s[0]][s[1]].val,o=(this.tileArray[t][i]||{}).val,c=n?s[0]===t:s[1]===i;return void 0!==e&&c&&e===o}return!1},_checkMatch3(e){e.length>4&&(e=e.slice(e.length-4));const t=e.map(e=>(this.tileArray[e[0]][e[1]]||{}).isThunder).filter(Boolean).length;if(e.length>3&&!t){let t=e.pop(),i=this.tileArray[t[0]][t[1]],n=!0;e.forEach((e,o)=>{n=t[0]===e[0];const c=this.tileArray[e[0]][e[1]],r=cc.MoveTo.create(this.speedAnimation,new cc.Point(i.x+4*o,i.y)),a=cc.callFunc(function(){c.removeFromParent(!0),i.addChild(c,0),c.setPosition(s.midTileSize-4*(o+1),s.midTileSize-4*(o+1))},this);c&&(c.animationAction=[r,a],this.animationQueue.push(c),this.tileArray[e[0]][e[1]]=null)});const o=n?"horizontally":"vertically",c=s.getBallSprite(o);i.addChild(c,1),c.setPosition(s.midTileSize-10,s.midTileSize-10),i.isThunder=o}else this._checkToRemove(e)},_checkToRemove(e){e.length>2&&e.forEach(e=>this._removeTileSprite(e[0],e[1]))},_removeTileSprite(e,t){const i=this.tileArray[e][t];let n=cc.scaleTo(.5,1.5);if(null===i||"x"===i)return!1;i.isThunder&&this._removeThunderTile(e,t),i.val===s.goal.val&&(s.setCollectedGoals(i.isThunder?4:1),n=cc.MoveTo.create(this.speedAnimation,new cc.Point(-1*s.layout.aside.width,s.layout.aside.height/2)));const o=cc.callFunc(function(){this.removeFromParent(!0)},i);i.animationAction=[n,o],this.animationQueue.push(i),this.tileArray[e][t]=null},_removeThunderTile(e,t){const i=this.tileArray[e][t];for(let n=0;n<this.tileArray.length;n++)"vertically"===i.isThunder&&e!==n&&this._removeTileSprite(n,t),"horizontally"===i.isThunder&&t!==n&&this._removeTileSprite(e,n)},_onMouseDown(e){const t={row:Math.floor((e._y-s.midPoint.y)/s.tileSize),col:Math.floor((e._x-(s.midPoint.x+300))/s.tileSize)},i=(this.tileArray[t.row]||[])[t.col];"object"==typeof i&&null!==i&&(this.visitedTiles[t.row+"-"+t.col]=t,s.boost.enable&&this._clickBoost(t),128===i.getOpacity()&&this._doubleClick(i,t),this._enabledSelect(i))},_onMouseMove(e){null!==e._button&&1===Object.keys(this.visitedTiles).length&&this._onMouseDown(e)},_enabledSelect(e){e.setOpacity(128)},_clickBoost(e){this._removeTileAndNext(e),s.boost.enable=!1},_doubleClick(e,t){e.isThunder&&this._removeTileAndNext(t)},_removeTileAndNext(e){this._removeTileSprite(e.row,e.col),this._next(),this.visitedTiles={}},_onMouseUp(){if(2===Object.keys(this.visitedTiles).length){const e=Object.keys(this.visitedTiles)[0],t=Object.keys(this.visitedTiles)[1],i=this.visitedTiles[e].row,n=this.visitedTiles[e].col,o=this.visitedTiles[t].row,c=this.visitedTiles[t].col,r=Math.abs(i-o),a=Math.abs(n-c),h=this.tileArray[i][n],l=this.tileArray[o][c];if(h&&l){if(r+a===1){const e=cc.MoveTo.create(this.speedAnimation,new cc.Point(h.x,h.y)),t=cc.MoveTo.create(this.speedAnimation,new cc.Point(l.x,l.y)),r=cc.callFunc(function(){this._next()},this);l.runAction(cc.sequence(e,r)),h.runAction(t),this.tileArray[i][n]=l,this.tileArray[o][c]=h,s.setMove()}this._disableSelect(h),this._disableSelect(l)}this.visitedTiles={}}},_disableSelect(e){e.setOpacity(255)},_addTile:function(e,t,i){if("x"!==i){let n=Math.floor(Math.random()*s.ballsColor.length);s.ballsColor.forEach((e,t)=>{i===e[0]&&(n=t)});const o=s.getBallSprite(s.ballsColor[n]);return o.val=n,this.addChild(o,0),o.setPosition(t*s.tileSize+s.midTileSize,e*s.tileSize+s.midTileSize),o}return i}});var d=cc.LayerColor.extend({init(){this._super(),this.changeWidthAndHeight(s.layout.board.width,s.layout.board.height),this.setPosition(cc.p(s.layout.aside.width,0)),this.addChild(cc.LayerGradient.create(cc.color(0,34,34,255),cc.color(34,0,68,255))),s.setMidPoint(this.getContentSize());const e=new h;e.setPosition(s.midPoint),this.addChild(e);const t=new l;t.setPosition(s.midPoint),this.addChild(t)}});var u=cc.LayerColor.extend({ctor:function(e=!0){this._super(),this.isWin=e;const t=cc.director.getWinSize(),i=cc.color(100,100,100,0);this.touchListener=cc.EventListener.create({event:cc.EventListener.MOUSE,onMouseDown:()=>!0,onMouseUp:()=>!0,onMouseMove:()=>!0}),window.touchListener=this.touchListener,cc.eventManager.addListener(this.touchListener,this),this.changeWidthAndHeight(t.width-10,t.height-10),this.setColor(i),this.ignoreAnchorPointForPosition(!1),this.setPosition(cc.p(t.width/2,t.height/2)),this.setBlendFunc(cc.SRC_ALPHA,cc.ONE);const n=this.getContentSize(),o=new cc.LayerColor(s.colorBoardTitle.darkGray,t.width/2,t.height/1.5);o.ignoreAnchorPointForPosition(!0),o.setBlendFunc(!1,!1),this.addChild(o),o.x=t.width/4,o.y=t.height/4;const c=new cc.LabelTTF;c.string=this.isWin?"Ты выиграл":"Ты проиграл",c.font="85px 'Arial'",c.fillStyle=cc.color(0,0,0),c.x=n.width/2,c.y=n.height-100,this.addChild(c);const r=[new cc.MenuItemFont("Рестарт",this.onPushRestart,this),new cc.MenuItemFont("Выход",this.onPushExit,this),new cc.MenuItemFont("+ Ходы",this.onPushAddStep,this)].map(e=>(e.setFontSize(80),e.setFontName("Arial"),e));this.isWin&&r.pop();const a=new cc.Menu(...r);a.alignItemsVertically(),a.setPosition(n.width/2,n.height/2),this.addChild(a)},onPushRestart(){cc.eventManager.dispatchEvent(new cc.EventCustom("close_popup")),cc.eventManager.dispatchEvent(new cc.EventCustom("restart"))},onPushExit(){window.close()},onPushAddStep(){s.setMove(-5),cc.eventManager.dispatchEvent(new cc.EventCustom("close_popup"))}}),v=["assets/globes.plist","assets/globes.png"];var p=cc.Scene.extend({onEnter:function(){this._super(),this.aside=new a,this.gameLayer=new d,cc.spriteFrameCache.addSpriteFrames(...v),this.addChild(this.aside),this.addChild(this.gameLayer),s.init(),this.gameLayer.init(),this._listenerOnShowPopup=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"show_popup",callback:e=>{const t=e.getUserData(),i=new u(t);this.currentChild&&this.removeChild(this.currentChild,!0),this.addChild(i),this.currentChild=i}}),this._listenerOnClosePopup=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"close_popup",callback:()=>{this.removeChild(this.currentChild),this.currentChild=null}}),this._listenerOnRestart=cc.EventListener.create({event:cc.EventListener.CUSTOM,eventName:"restart",callback:()=>{this.removeChild(this.gameLayer),this.gameLayer=new d,this.addChild(this.gameLayer),this.gameLayer.init(),s.init()}}),cc.eventManager.addListener(this._listenerOnShowPopup,1),cc.eventManager.addListener(this._listenerOnClosePopup,1),cc.eventManager.addListener(this._listenerOnRestart,1)},onExit:function(){cc.eventManager.removeListener(this._listenerOnShowPopup),cc.eventManager.removeListener(this._listenerOnClosePopup),cc.eventManager.removeListener(this._listenerOnRestart),this._super()}});window.onload=(()=>{cc.game.onStart=(()=>{cc.view.setDesignResolutionSize(s.layout.width,s.layout.height,cc.ResolutionPolicy.SHOW_ALL),cc.LoaderScene.preload(v,()=>cc.director.runScene(new p),void 0)}),cc.game.run("gameCanvas")})}]);